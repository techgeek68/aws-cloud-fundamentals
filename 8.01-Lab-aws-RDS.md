# Lab: Build Your DB Server and Interact With Your DB Using an App

---

## Prerequisites

- AWS account with permissions for VPC, EC2, RDS
- Region: us-east-1 (N. Virginia) or your preferred region

---

## 1. **Create a VPC**
   1. In the AWS Console, go to the **VPC** service.
   2. Click **Your VPCs** in the left navigation pane, then **Create VPC**.
   3. Select **VPC only**.
   4. Configure:
      - **Name tag:** `Lab VPC`
      - **IPv4 CIDR block:** `10.0.0.0/16`
      - **IPv6 CIDR block:** No IPv6 CIDR (leave unchecked/None)
      - **Tenancy:** Default
   5. Click **Create VPC**.

---

## 2. **Create Subnets** (at least three: one public, two private for DB)

   - Go to **Subnets** in the VPC console.
   - Click **Create subnet**.
   - Configure and create subnets as follows:

   **a) Public-subnet-01 (for Web/App Server)**
   - **VPC:** Lab VPC
   - **Subnet name:** `Public-subnet-01`
   - **Availability Zone:** `us-east-1a`
   - **IPv4 CIDR block:** `10.0.0.0/24`

   **b) DB-subnet-01 (Private for RDS)**
   - **VPC:** Lab VPC
   - **Subnet name:** `DB-subnet-01`
   - **Availability Zone:** `us-east-1a`
   - **IPv4 CIDR block:** `10.0.1.0/24`

   **c) DB-subnet-02 (Private for RDS)**
   - **VPC:** Lab VPC
   - **Subnet name:** `DB-subnet-02`
   - **Availability Zone:** `us-east-1b`
   - **IPv4 CIDR block:** `10.0.3.0/24`

   - Click **Create subnet** after configuring each.

---

## 3. **Create an Internet Gateway and Attach to VPC**

   1. Go to **Internet Gateways** in the VPC console.
   2. Click **Create internet gateway**.
      - **Name tag:** `Lab-igw`
   3. Create and **attach it to Lab VPC**.

---

## 4. **Configure Route Tables**

### a) **Public Route Table (for Public-subnet-01)**
   1. Go to **Route Tables** in the VPC console.
   2. Create a new route table:
      - **Name tag:** `Lab-public-rt`
      - **VPC:** Lab VPC
   3. Select the new route table, go to **Routes** tab > **Edit routes**.
      - Add route:
        - **Destination:** `0.0.0.0/0`
        - **Target:** Your Internet Gateway (`Lab-igw`)
   4. Go to **Subnet associations** tab > **Edit subnet associations**.
      - **Select:** `Public-subnet-01`
      - Click **Save associations**.

### b) **Private Route Table (optional, for DB subnets)**
   - The default route table (created with your VPC) can be used for private subnets. No route to Internet Gateway is needed for DB subnets.

---

## 5. **Create Security Groups**

### a) **Web Security Group**
- In **EC2 > Security Groups**
  - Name: `Web Security Group`
  - Description: Allow HTTP/SSH from anywhere (or your IP)
  - VPC: Lab VPC
  - Inbound Rule: HTTP (80) from `0.0.0.0/0`
  - Inbound Rule: SSH (22) from `0.0.0.0/0` or Only from your IP
  - Outbound: All traffic

### b) **DB Security Group**
- Name: `DB Security Group`
- Description: Permit access from Web Security Group
- VPC: Lab VPC
- Inbound Rule: MySQL/Aurora (3306) source from **Web Security Group** (select by SG ID)
- Outbound: All traffic

---

## 6. **Create a DB Subnet Group**

1. Go to **RDS > Subnet groups > Create DB Subnet Group**
2. Name: `Lab-DB-Subnet-Group`
3. Description: `DB Subnet Group`
4. VPC: Lab VPC
5. Add subnets: Availability Zones`us-east-1a` `us-east-1b`, Subnets: **DB-subnet-01** and **DB-subnet-02**
6. Create

---

## 7. **Launch Amazon RDS Multi-AZ DB Instance**

1. Go to **RDS > Databases > Create database**
2. Standard create
3. Engine: **MySQL**
4. Template: **Dev/Test**
5. Availability: **Multi-AZ DB instance(2 instances)**
6. Settings:
    - DB instance identifier: `lab-db`
    - Master username: `admin`
    - Self managed credentials
    - Master password: `lab-password`
7. DB instance class: Burstable classes `db.t3.micro`
8. Storage: General Purpose SSD (gp2), 20 GiB
9. Connectivity:
    - Don't connect to an EC2 compute resource
    - Network type: IPV4
    - VPC: Lab VPC
    - Subnet group: `Lab-DB-Subnet-Group`
    - **Public access: No**
    - VPC Security Group: **DB Security Group**
    - Enhanced Monitoring **Disable**
10. Additional configuration:
    - Initial database name: `lab`
11. Click **Create database**.
12. Wait until status is **Available**.  
    - Copy the **Endpoint** for later.
    - Click on your RDS database instance.
    - Under the Connectivity & security tab, look for Endpoint & port.
    - The endpoint will look like: `lab-db.cr0s8miyua9l.us-east-1.rds.amazonaws.com`

---

## 8. **Launch a Web Server EC2 Instance in the Public Subnet**

1. Go to **EC2 > Instances > Launch Instances**
    - Name: `DBAppServer`
    - AMI: Amazon Linux 2
    - Instance type: `t2.micro`
    - Key pair: Create/download as needed
    - Network: Edit **Lab VPC**, **Subnet: Public-subnet-01**
    - Auto-assign public IP: **Enable**
    - Security group: **Web Security Group**
    - Lunch instance
2. Wait for the instance to start.
3. Note the public IP address.

---

## 9. **Deploy a Web App on the Instance**

- Go to the directory where the key is located, `chmod 400 	dbkey.pem` 
- SSH into the instance:
   - Syntax `ssh -i <keypair.pem> ec2-user@<AppServer-Public-IP>`
     
  Example:
    ```sh
       ssh -i "dbkey.pem" ec2-user@3.231.105.221
    ```
    
- Install Apache, PHP, and MySQL client:
    ```sh
       sudo yum update -y
    ```
    ```sh
       sudo yum install -y httpd php php-mysqlnd
    ```
    ```sh
       sudo systemctl enable httpd
    ```
    ```sh
       sudo systemctl start httpd
    ```
- Deploy a sample PHP app that connects to MySQL using the RDS endpoint.
    - Place your `index.php` and `config.php` in `/var/www/html/`
    - Example `sudo vim index.php`
```php
     <?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

require_once 'config.php';

// Create students table if it doesn't exist
$tableSql = "CREATE TABLE IF NOT EXISTS students (
    id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    age INT,
    college_name VARCHAR(100),
    program_name VARCHAR(100),
    year INT,
    semester VARCHAR(20)
)";
$conn->query($tableSql);

// Handle insert form submission
$insertMsg = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_student'])) {
    $fn = $conn->real_escape_string($_POST['first_name']);
    $ln = $conn->real_escape_string($_POST['last_name']);
    $age = intval($_POST['age']);
    $college = $conn->real_escape_string($_POST['college_name']);
    $program = $conn->real_escape_string($_POST['program_name']);
    $year = intval($_POST['year']);
    $semester = $conn->real_escape_string($_POST['semester']);

    $sql = "INSERT INTO students (first_name, last_name, age, college_name, program_name, year, semester)
            VALUES ('$fn', '$ln', $age, '$college', '$program', $year, '$semester')";
    if ($conn->query($sql)) {
        $insertMsg = "<span style='color: green;'>Student added successfully!</span>";
    } else {
        $insertMsg = "<span style='color: red;'>Error: {$conn->error}</span>";
    }
}

// Handle search form submission
$searchResult = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['search_student'])) {
    $fn = $conn->real_escape_string($_POST['search_first_name']);
    $ln = $conn->real_escape_string($_POST['search_last_name']);

    $sql = "SELECT * FROM students WHERE first_name='$fn' AND last_name='$ln' LIMIT 1";
    $res = $conn->query($sql);
    if ($res && $res->num_rows > 0) {
        $student = $res->fetch_assoc();
        $searchResult = "<h3>Student Found:</h3>
        <ul>
            <li>First Name: {$student['first_name']}</li>
            <li>Last Name: {$student['last_name']}</li>
            <li>Age: {$student['age']}</li>
            <li>College Name: {$student['college_name']}</li>
            <li>Program Name: {$student['program_name']}</li>
            <li>Year: {$student['year']}</li>
            <li>Semester: {$student['semester']}</li>
        </ul>";
    } else {
        $searchResult = "<span style='color: red;'>No student found with that name.</span>";
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Student Database Web App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        form { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; width: 350px;}
        h2 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>Student Database Web App</h1>

    <h2>Add New Student</h2>
    <?php echo $insertMsg; ?>
    <form method="post">
        <label>First Name: <input type="text" name="first_name" required></label><br><br>
        <label>Last Name: <input type="text" name="last_name" required></label><br><br>
        <label>Age: <input type="number" name="age" required></label><br><br>
        <label>College Name: <input type="text" name="college_name" required></label><br><br>
        <label>Program Name: <input type="text" name="program_name" required></label><br><br>
        <label>Year: <input type="number" name="year" required></label><br><br>
        <label>Semester: <input type="text" name="semester" required></label><br><br>
        <input type="submit" name="add_student" value="Add Student">
    </form>

    <h2>Search Student</h2>
    <form method="post">
        <label>First Name: <input type="text" name="search_first_name" required></label><br><br>
        <label>Last Name: <input type="text" name="search_last_name" required></label><br><br>
        <input type="submit" name="search_student" value="Search">
    </form>

    <?php echo $searchResult; ?>

</body>
</html>
```
      
    - Example `sudo vim config.php`:
```php
<?php
define('DB_HOST', 'lab-db.cr0s8miyua9l.us-east-1.rds.amazonaws.com'); // Replace with your own
define('DB_USER', 'admin');        // RDS master username (from your setup)
define('DB_PASS', 'lab-password'); // RDS master password
define('DB_NAME', 'lab');          // Initial database name
$conn = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
?>
```
   - Restart the Apache web server
```bash
sudo systemctl restart httpd
```
   - 
---

## 10. **Connect the App to the RDS Database**

1. Open your web app (browser, using the EC2 public IP).
2. Your PHP app should connect to the RDS endpoint with the credentials above.

---

## 11. **Test and Validate**

- Add/edit/delete records in the app.
- Confirm data persists and is stored in the RDS database.

---

## 12. **(Optional) Clean Up Resources**

- Terminate EC2 instance
- Delete RDS DB instance and snapshots
- Delete security groups, subnet group, subnets, route tables, and VPC

---

## **Troubleshooting**

| Symptom                   | Possible Cause                       | Fix                                  |
|---------------------------|--------------------------------------|--------------------------------------|
| App can't connect to DB   | Security groups, wrong endpoint      | Check DB SG, use correct endpoint    |
| RDS not accessible        | Wrong VPC/subnet group/Security group| Check networking and SG config       |
| No public IP on instance  | Subnet not public/auto-assign off    | Use public subnet, assign public IP  |
| App errors                | PHP/MySQL not installed              | Install required packages            |

---

## **Architecture Recap**

```
[Internet]
   |
   v
[AppServer EC2] --(Web SG)--> [RDS MySQL Multi-AZ] --(DB SG)-->
     |                        ^
     |                        |
[Public Subnet]        [Private Subnets in 2 AZs]
```

---

© 2025, Amazon Web Services, Inc. All rights reserved.
