# Lab: Scale and Load Balance Your Architecture on AWS

## Lab Overview

This lab guides you through building a fault-tolerant and scalable web architecture using AWS services:
- **Elastic Load Balancing (ELB)** to distribute traffic across EC2 instances
- **Auto Scaling** to automatically adjust the number of EC2 instances based on demand
- **CloudWatch** for monitoring and alarms

By the end, you'll have an architecture that automatically scales and balances load, with monitoring in place.

---

## Prerequisites

- AWS account with administrative privileges
- AWS CLI (optional, for advanced users)
- Basic understanding of EC2, VPC, and Security Groups

---

### Step 1: Set Up the VPC and Subnets

1. **Create a VPC**
   - Go to **VPC Dashboard** > **Create VPC**
   - VPC and more
   - Name tag: `Lab VPC`
   - IPv4 CIDR: `10.0.0.0/16`
   - Tenancy: `Default`
   - Number of Availability Zones (AZs): `2`
   - Number of public subnets:`2`
   - Number of private subnets:`2`
   - Enable DNS resolution: Checked
   - Enable DNS hostnames: Checked

2. **Subnets**
  The above action will result in:
  - `Lab VPC-subnet-public1-us-east-1a`
  - `Lab VPC-subnet-public2-us-east-1b`
  - `Lab VPC-subnet-private1-us-east-1a`
  - `Lab VPC-subnet-private2-us-east-1b`

3. **Internet Gateway**
   - `Lab VPC-igw` will be attached to `Lab VPC`

4. **Route Tables**
   - Select public route table `Lab VPC-rtb-public`: Routes to `0.0.0.0/0` and `10.0.0.0/16` via Internet Gateway and local, associate with Public Subnets
   - Private route table: No direct route to IGW

---

### Step 2: Set Up Security Groups

1. **Create a Security Group:** `Web Security Group`
   - Attach to `Lab VPC`
   - Inbound rules:
     - Allow HTTP (TCP/80) from anywhere (0.0.0.0/0)
     - Allow SSH (TCP/22) from your IP
   - Outbound: > Type: All traffic > Destination type: Anywhere-IPV4

---

## Step 3: Launch and Configure Initial EC2 Instance

1. Go to **EC2 > Instances > Launch Instances**.
2. Configure:
    - **Name:** `MyAppServer`
    - **AMI:** Amazon Linux 2 (or your preferred OS)
    - **Instance type:** `t2.micro`
    - **Key pair:** Create/download as needed
    - **Network:** Use the earlier VPC, `Lab VPC`
    - **Subnet:** `Lab VPC-subnet-public1-us-east-1a` *Public subnet for initial testing*
    - **Auto-assign public IP**: `Enable`
    - **Security Group:** Select existing security group `Web Security Group`

3. **Advanced details**
   
    **Detailed CloudWatch monitoring**: Enable
   
   **User Data:** Add a script to install and start your web app.

```
#!/bin/bash
sudo dnf update -y
sudo dnf install -y httpd php-cli php-fpm php-mysqlnd php-common php-gd php-xml php-opcache
sudo systemctl enable --now php-fpm httpd

#Download Bootstrap and logo
sudo mkdir -p /var/www/html/css /var/www/html/js /var/www/html/img
sudo curl -o /var/www/html/css/bootstrap.min.css https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css
sudo curl -o /var/www/html/js/bootstrap.min.js https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js
sudo curl -o /var/www/html/js/jquery.min.js https://code.jquery.com/jquery-3.7.1.min.js
sudo curl -o /var/www/html/img/cloud_logo.png https://yourdomain.com/cloud_logo.png

sudo cat << 'EOF' > /var/www/html/load.php

<?php
// Simulate CPU load for 2 seconds
$start = microtime(true);
while ((microtime(true) - $start) < 2) {
    sqrt(rand());
}
?>
<!DOCTYPE html>
<html>
  <head>
    <title>Cloud Foundations Lab - Load Test</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <meta http-equiv="refresh" content="5;URL=/load.php" />
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <nav class="navbar navbar-default" role="navigation">
            <div class="navbar-header">
              <a class="navbar-brand" href="/"><img height="25" src="img/cloud_logo.png" alt="Cloud Lab Logo" /></a>
            </div>
          </nav>
          <div class="jumbotron">
            <h2>Under High CPU Load!</h2>
            <table class="table table-bordered">
              <tr>
                <th>Meta-Data</th>
                <th>Value</th>
              </tr>
              <tr>
                <td>InstanceId</td>
                <td><i>
<?php
$instanceId = @file_get_contents('http://169.254.169.254/latest/meta-data/instance-id');
echo $instanceId ? htmlspecialchars($instanceId) : 'Unknown';
?>
                </i></td>
              </tr>
              <tr>
                <td>Availability Zone</td>
                <td><i>
<?php
$az = @file_get_contents('http://169.254.169.254/latest/meta-data/placement/availability-zone');
echo $az ? htmlspecialchars($az) : 'Unknown';
?>
                </i></td>
              </tr>
            </table>
            <hr />
            <p>Current CPU Load: <b>100%</b></p>
            <p>This page auto refreshes every 5 seconds to simulate continuous load.</p>
          </div>
        </div>
      </div>
    </div>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>
EOF
```

4. **Launch** the instance and wait until the status is `running`.

---

## Step 4: Create an AMI (Machine Image) from the Instance

1. In **EC2 > Instances**, select `MyAppServer`.
2. **Actions > Image and templates > Create image**.
    - **Image name:** `AppServerAMI`
    - **Description:** `Lab AMI for APP Server`
3. Click **Create image** and wait for it to appear in **EC2 > AMIs**. Wait until status: Available.

---
### Step 5: Create Target Group and Load Balancer

#### a) Create Target Group

1. EC2 Dashboard > Load Balancing > Target Groups
2. Create target group:
   - Target type: Instances
   - Name: `LabTargetGroup`
   - VPC: `Lab VPC`
   - Protocol: HTTP, Port: 80
   - Next, the `Register targets` screen appears.
   - Create target group

#### b) Create Application Load Balancer

1. EC2 Dashboard > Load Balancing > Load Balancers > Create Load Balancer
2. Type: **Application Load Balancer**
   - Name: `LabLoadBalance`
   - Scheme: Internet-facing
   - Listeners: HTTP (port 80)
   - VPC: `Lab VPC`
   - Availability Zones and Subnets: Select both, assign Public Subnet 1 & 2
     - us-east-1a: `Lab VPC-subnet-public1-us-east-1a`
     - us-east-1b: `Lab VPC-subnet-public1-us-east-1b`
   - Security Groups: Attach only `Web Security Group`
   - Listener rules: Default action forward to `LabTargetGroup`
3. Create and note the DNS name

---

### Step 6: Create Launch Template

1. EC2 Dashboard > Instances > Launch Templates > Create launch template
   - Name: `LabLoadBalanceConfig`
   - Template version description: A server for MyApp
   - Auto Scaling guidance: Checked `Provide guidance to help me set up a template that I can use with EC2 Auto Scaling`
   - AMI: My AMIs > Owned by me > Select `AppServerAMI`
   - Instance type: `t2.micro`
   - Key pair: `Select the key that was created by you`
   - Security Group: `Web Security Group`
   - Enable Detailed CloudWatch Monitoring
   - Create launch template
     
---

### Step 7: Configure Auto Scaling Group

1. **Create Auto Scaling Group**
   - EC2 Dashboard > Auto Scaling Groups > Create
   - Name: `Lab Auto Scaling Group`
   - Launch template: `LabLoadBalanceConfig`
   - VPC: `Lab VPC`
   - Subnets: Private Subnet 1 & 2
   - Attach to an existing load balancer > Choose from your load balancer target groups > select `LabTargetGroup | HTTP`
   - Group size:
     - Desired capacity: 2
     - Min: 2
     - Max: 6
   - Automatic scaling - optional > Target tracking scaling policy
     - Name: `LabScalingPolicy`
     - Metric: Average CPU Utilization
     - Target value: 60
   - Add notifications - optional
     - Notification 1
       - Create Topic:
         -  Send a notification to: `ServerWatch`
         -  With these recipients: `Your email ID`
   - Tags: Key=`Name`, Value=`Lab Instance`
   - Review & Create

---

### Step 8: Verify Load Balancing & Auto Scaling

1. **Check Instances**
   - EC2 Dashboard > Instances
   - Should see 2 running instances named `Lab Instance` (created by Auto Scaling)

2. **Check Target Group**
   - EC2 Dashboard > Target Groups > `LabTargetGroup` > Targets
   - Both instances should show "healthy" status

3. **Test Load Balancer**
   - EC2 Dashboard > Load Balancing > Load Balancers > `LabLoadBalance`
   -  Copy DNS name from `LabLoadBalance`
   - Paste into browser
   - Should see web app (e.g., hostname)

---

### Step 9: Test Auto Scaling Response

1. **Check CloudWatch Alarms**
   - CloudWatch Dashboard > Alarms
   - Should see alarms for Average CPU Utilization

2. **Generate Load**
   - Access web app and use any built-in load test feature (if available)
   - Alternatively, run a stress test on instances

3. **Observe Scaling**
   - CloudWatch > Alarms: Watch for AlarmHigh to trigger
   - EC2 Dashboard > Instances: More instances appear as demand increases

---

### Step 10: Clean Up

1. **Terminate Initial Instance**
   - EC2 Dashboard > Instances > select `MyAppServer`
   - Actions > Instance State > Terminate

2. **Delete Resources**
   - Auto Scaling Group
   - Load Balancer
   - Target Group
   - Launch Template
   - AMI (optional)
   - EC2 Instances
   - VPC/Subnets/IGW (if not needed for other labs)

---
