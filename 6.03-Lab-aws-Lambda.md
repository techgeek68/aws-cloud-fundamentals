# Lab: Build an AWS Lambda Function Triggered by EventBridge

---

**Objectives:**
- Create a Lambda function (`myStopinator`) using Python 3.11
- Assign an existing IAM role (`myStopinatorRole`) to the function
- Set up an EventBridge rule (`everyMinute`) to trigger the function every minute
- Configure the Lambda code with the correct region and EC2 instance ID
- Deploy and verify successful operation

---

## Architectural Diagram

```
                                +-------------------------------+
                                |        EventBridge Rule       |
                                |  (rate(1 minute): everyMinute)|
                                +---------------+---------------+
                                                |
                                     (Triggers Lambda Function)
                                                |
                                       +--------v----------+
                                       |   Lambda Function |
                                       |   myStopinator    |
                                       +--------+----------+
                                                |
                                     (Assumes IAM Role: myStopinatorRole)
                                                |
                                       +--------v----------+
                                       |   EC2 API Call    |
                                       | Stop Instance(s)  |
                                       +--------+----------+
                                                |
                                       +--------v----------+
                                       |  EC2 Instance(s)  |
                                       | (e.g., instance1) |
                                       +-------------------+
```

---

## Task 1: Create a Lambda Function

### 1. Go to Lambda:
- In the AWS Console search bar (top center), type **Lambda** and select it.

### 2. Create a Function:
- Click **Create function** (orange button).
- Set these options:
  - **Author from scratch** (should be the default).
  - **Function name:** `myStopinator`
  - **Runtime:** `Python 3.11`
- Under **Change default execution role**:
  - Click the dropdown and select **Use an existing role**.
  - In **Existing role**, choose `myStopinatorRole` from the dropdown.
- Click **Create function** at the bottom.

---

## Task 2: Configure the Trigger (EventBridge Rule)

### 1. Add Trigger:
- In your new Lambda function page, click **Add trigger**.

### 2. Set Up EventBridge:
- From the **Select a trigger** dropdown, choose **EventBridge (CloudWatch Events)**.

### 3. Create a New Rule:
- Choose **Create a new rule**.
- Set:
  - **Rule name:** `everyMinute`
  - **Rule type:** `Schedule expression`
  - **Schedule expression:** `rate(1 minute)`
- Click **Add**.


---

## Task 3: Configure the Lambda Function Code

### 1. Edit Lambda Code:
- Scroll down to the **Code** section.
- Click on `lambda_function.py` to open the code editor.

### 2. Replace the Code:
- Delete all existing code in the editor.
- Copy and paste this template:

    ```python
    import boto3
    region = '<REPLACE_WITH_REGION>'
    instances = ['<REPLACE_WITH_INSTANCE_ID>']
    ec2 = boto3.client('ec2', region_name=region)

    def lambda_handler(event, context):
        ec2.stop_instances(InstanceIds=instances)
        print('stopped your instances: ' + str(instances))
    ```

### 3. Find Your Region:
- In the AWS Console (top right), note the region (e.g., `us-east-1`).
- Replace `<REPLACE_WITH_REGION>` with your region code, **in single quotes**.
    ```python
    region = 'us-east-1'
    ```

### 4. Get Your EC2 Instance ID:
- Open a new tab and go to the **EC2** service.
- Find the instance named **instance1**.
- Copy its **Instance ID** (e.g., `i-0123456789abcdef0`).

### 5. Update the Instance ID in the Code:
- Replace `<REPLACE_WITH_INSTANCE_ID>` with your instance ID, **in single quotes**.
    ```python
    instances = ['i-0123456789abcdef0']
    ```

### 6. Save and Deploy:
- Click **File > Save**.
- Click **Deploy** (orange button above the code editor).

---

## Task 4: Monitor and Verify Lambda Execution

### 1. Go to the Monitor Tab:
- In your Lambda function page, click the **Monitor** tab.
- View the invocation, errors, and success rate charts.

### 2. Verify EC2 Is Stopped:
- Go to the **EC2** console (in another tab or window).
- Wait a minute, then **refresh** the instance list.
- Confirm that **instance1** is now in the **stopped** state.


### 3. Try Starting the Instance:
- Select the instance and click **Start**.
- Wait a minute and refreshâ€”the Lambda will stop it again!

---




```
---
